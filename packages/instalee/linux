#!/bin/sh
set -eo pipefail
# From https://aur.archlinux.org/cgit/aur.git/tree/PKGBUILD?h=instalee-git
_pkgname='instalee'
cd "$(readlink /proc/$(ps -o ppid= $(ps -o ppid= $PPID) | tr -d ' ')/cwd || $dir_home)"
pkgdir=/tmp
usrdir="${pkgdir}/usr/local"
bin="${usrdir}/bin"
sudo install -D --target-directory "${usrdir}/share/doc/${_pkgname}/" *.md
sudo install -D --target-directory "${usrdir}/share/man/man1/" "${_pkgname}.1"
sudo install -D --target-directory "$bin" "${_pkgname}"

pkgver="$(git describe --long --tags 2>/dev/null | sed 's/^v//;s/\([^-]*-g\)/r\1/;s/-/./g' || printf "r%s.%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)")"
sudo sed -i "s/r%s.%s/version ${pkgver}/" "$bin/${_pkgname}"

echo -n "Installed "
$bin/instalee --version
